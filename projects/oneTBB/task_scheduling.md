# oneTBB 模块: 任务调度 (Task Scheduling)

## 概述

任务调度是 oneTBB 库的核心引擎，负责在可用的硬件线程上高效地管理和执行用户提交的任务。它旨在最大化并行度，同时提供对任务执行、同步、取消和资源管理的控制。

## 核心组件与功能

1.  **任务 (Task)**: (主要由 `detail/_task.h` 定义，但被上层组件使用)
    *   **功能**: TBB 内部的基本工作单元。用户通常不直接创建 `tbb::task` 对象，而是通过更高级别的接口（如 `parallel_for`, `task_group`, `task_arena::enqueue`）间接创建。
    *   **特点**: 任务可以被分解（spawn）成子任务，形成任务树或任务图。调度器负责执行这些任务。

2.  **任务调度器 (Task Scheduler)**: (内部机制，用户不直接交互)
    *   **功能**: 管理一个或多个线程池，并将待执行的任务分发给工作线程。
    *   **特点**: 采用工作窃取（work-stealing）算法来负载均衡。空闲的线程会尝试从其他繁忙线程的任务队列中"窃取"任务来执行，以保持高利用率。

3.  **`task_arena`**:
    *   **功能**: 代表一个独立的任务执行环境或"竞技场"。它管理一组线程，并为提交到该竞技场的任务提供执行上下文。
    *   **特点**:
        *   **并发控制**: 可以限制同时在此竞技场中运行的线程数 (`max_concurrency`)。
        *   **任务入队**: 提供 `enqueue()` 方法，允许将任务（通常包装为 `task_handle` 或 lambda）提交到此竞技场执行，而无需当前线程立即参与执行。
        *   **执行与等待**: 提供 `execute()` 方法，在竞技场内执行一个函数（通常是 lambda），并等待其关联的所有 TBB 任务完成。
        *   **隔离**: `isolate()` 函数可以在竞技场内创建一个隔离的执行环境。
        *   **优先级与亲和性**: 支持设置竞技场优先级，并可能支持绑定到特定的 NUMA 节点或 CPU 核心类型 (Arena Binding 功能)。
    *   **使用场景**: 需要控制特定代码块的并发级别、将任务提交到特定线程池、管理不同组件或库的线程资源、优化 NUMA 性能等。

4.  **`task_group` / `task_group_context`**:
    *   **功能**: `task_group` 用于管理一组相关的任务，并提供同步机制。`task_group_context` (通常隐式关联) 负责处理该组任务的取消状态和异常传播。
    *   **特点**:
        *   **任务添加**: 使用 `run(F&& func)` 添加任务（函数对象）。
        *   **等待完成**: `wait()` 方法阻塞调用线程，直到组内所有任务完成。
        *   **取消**: 可以通过 `cancel()` 方法或由未捕获的异常触发组内任务的取消。正在运行或等待运行的任务可以检查取消状态 (`is_group_execution_cancelled()`)。
        *   **异常处理**: `wait()` 会重新抛出组内任务发生的异常（如果有的话）。
        *   **上下文**: `task_group_context` 可以是独立的 (`isolated`) 或绑定到父上下文 (`bound`)，形成取消传播链。
    *   **使用场景**: 需要启动一组任务并等待它们全部完成，同时需要统一处理异常和取消逻辑的场景，常见于 TBB 并行算法的内部实现和用户自定义的并行结构。

5.  **分区器 (Partitioner)**: (`partitioner.h`)
    *   **功能**: 虽然主要与并行算法（如 `parallel_for`）一起使用，但它体现了任务分割的策略，影响调度。
    *   **类型**: `auto_partitioner` (自动适应), `simple_partitioner` (简单分割), `static_partitioner` (静态预分割), `affinity_partitioner` (考虑缓存亲和性)。
    *   **作用**: 决定如何将大的工作范围分解成适合调度器处理的任务块。

6.  **全局控制 (Global Control)**: (`global_control.h` - 待分析)
    *   **功能**: 提供对 TBB 调度器全局参数的控制，例如默认的最大线程数。

## 设计思想

*   **工作窃取**: 核心调度算法，实现高效的负载均衡。
*   **任务作为基础**: 以轻量级的任务作为并行执行的基本单元。
*   **分层抽象**: 提供不同级别的抽象（`task` -> `task_group` / `task_arena` -> `parallel_algorithms`），方便用户根据需求选择合适的工具。
*   **显式并发控制**: `task_arena` 提供了对并发度和线程资源分配的明确控制。
*   **结构化取消与异常处理**: `task_group_context` 提供了结构化的方式来处理并行任务中的取消和异常。

## 依赖关系

*   是 TBB 大部分其他高级模块（如并行算法、流图）的基础。
*   依赖于底层的线程抽象和同步原语。
*   可能与内存管理模块交互（用于任务分配等）。

*(注意: 此文档是基于对 `task_arena` 和 `task_group` 的初步分析生成的，后续可根据需要进行补充和细化。)* 